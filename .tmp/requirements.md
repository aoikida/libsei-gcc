# 要件定義書 - libsei Ubuntu 22.04 移植プロジェクト

## Context7調査による技術的背景

### GCC Transactional Memory現状分析
- **GCC TMサポート継続**: Context7調査により、GCC 11/12でも`-fgnu-tm`フラグは削除されておらず、実験的機能として継続サポートされていることが確認された
- **アーキテクチャ依存**: TMサポートは全アーキテクチャで利用可能ではなく、x86_64での利用が推奨
- **libitm**: GCC TMランタイムライブラリとして、Global lock、Read-Writer lock、Lazy Snapshot Algorithmなどの複数実装を提供
- **Intel TM ABI**: Linux variant of Intel's current Transactional Memory ABI specification (Revision 1.1, May 6 2009)に準拠

### glibc互換性問題の詳細分析
- **Ubuntu 14.04環境**: eglibc 2.19を使用（glibcではない点に注意）
- **restrict修飾子の変更**: glibc関数宣言における`restrict`キーワードの追加により、古いコードとの互換性問題が発生
- **シンボルバージョニング**: glibcは後方互換性を「compat symbols」で維持するが、コンパイル時の関数宣言の違いは解決されない
- **具体的な問題関数**: `strtol`, `strtoll`, `strtoul`, `strtoull`, `realloc`, `memmove`, `strdup`, `strncpy`, `strcpy`系関数

## 1. 目的

libseiライブラリをUbuntu 14.04環境（eglibc 2.19 + GCC 4.7）からUbuntu 22.04環境（glibc 2.35 + GCC 11.4）に移植し、現代のコンパイラとライブラリ環境で正常にビルド・動作させること。

## 2. 機能要件

### 2.1 必須機能

- [ ] **ビルドシステムの修正**: Ubuntu 22.04 + GCC 11.4環境で正常にコンパイルできること
- [ ] **関数宣言の競合解決**: glibc 2.35との型宣言競合を解決すること
  - `strtol`, `strtoll`, `strtoul`, `strtoull`の`restrict`修飾子対応
  - `realloc`, `memmove_bsd`, `strdup`, `strncpy`, `strcpy`, `strndup`の宣言修正
  - **対応方法**: マクロ定義による条件付きコンパイルまたは適切な型キャストの使用
- [ ] **Transactional Memory互換性**: GCC 11.4のTMインターフェースに対応すること
  - **Context7調査結果**: `-fgnu-tm`は継続サポートされているが実験的機能のまま
  - Intel TM ABI specification (Revision 1.1)への準拠確認
  - `libitm`ライブラリとの互換性確保
- [ ] **インライン関数警告の解決**: `_ITM_*`関数群の静的変数アクセス警告を修正
- [ ] **アセンブリコードの互換性**: `.S`ファイル（`tmi_asm.S`, `tmi_read.S`）の現代的GCC対応
- [ ] **テストスイートの実行**: 既存のテスト（`make test`）が正常に実行されること
- [ ] **サンプルアプリケーションの動作**: `examples/simple`および`examples/ukv`が正常にビルド・実行されること
- [ ] **APIの後方互換性保持**: 既存のlibsei APIインターフェース（`__begin`, `__end`等）を変更しないこと

### 2.2 オプション機能

- [ ] **最新GCC最適化対応**: GCC 11.4の最新最適化フラグを活用した性能向上
- [ ] **静的解析対応**: 現代の静的解析ツール（clang-analyzer等）での警告対応
- [ ] **ドキュメント更新**: ビルド手順の現代化とトラブルシューティング情報の追加
- [ ] **eglibc→glibc移行対応**: Ubuntu 14.04のeglibc 2.19からUbuntu 22.04のglibc 2.35への完全対応

## 3. 非機能要件

### 3.1 パフォーマンス

- 元のlibseiライブラリと同等以上の実行性能を維持すること
- トランザクショナルメモリのオーバーヘッドが元の実装と同程度であること
- **Context7知見**: libitm提供の複数アルゴリズム（Global lock、Read-Writer lock、Lazy Snapshot Algorithm）の最適選択

### 3.2 セキュリティ

- 最新のコンパイラセキュリティ機能（スタック保護、FORTIFY_SOURCE等）との互換性
- メモリ安全性の維持
- **TME拡張**: AArch64 Transactional Memory Extension対応による将来拡張性

### 3.3 保守性

- 修正箇所のコメント追加と変更理由の文書化
- 将来のGCCバージョンアップに対する耐性の考慮
- **実験的機能への配慮**: GCC TMが実験的機能であることを考慮した保守可能な実装

### 3.4 互換性

- Ubuntu 22.04 LTS環境での動作保証
- GCC 11.x系での動作保証
- glibc 2.35との互換性
- **HTM対応**: PowerPCおよびx86のハードウェアトランザクショナルメモリとの互換性維持

## 4. 制約事項

### 4.1 技術的制約

- **コンパイラ**: GCC 11.4.0（Ubuntu 22.04デフォルト）を使用
- **プラットフォーム**: x86_64 Linux（TMアーキテクチャサポート制限による）
- **依存関係**: システム標準のglibc 2.35を使用
- **トランザクショナルメモリ**: GCC TM機能（`-fgnu-tm`）の継続使用（実験的機能）
- **Intel TM ABI準拠**: Revision 1.1, May 6 2009仕様への準拠

### 4.2 ビジネス制約

- 研究用途のライブラリであり、本番環境での使用は想定しない
- 既存のlibseiユーザー（学術研究者等）への互換性を重視
- 大幅なアーキテクチャ変更は避ける
- **実験的機能依存**: GCC TMの実験的性質によるリスクの受容

## 5. 成功基準

### 5.1 完了の定義

- [ ] `make clean && make`がエラーなく完了すること
- [ ] `make test`で全テストが成功すること
- [ ] `examples/simple/main`が期待通りに動作すること
- [ ] `examples/ukv`が正常にビルドされること
- [ ] 警告が最小限に抑制されること（zero warningsが理想）
- [ ] **TM機能検証**: 基本的なトランザクショナルメモリ操作が正常に動作すること

### 5.2 受け入れテスト

- Ubuntu 22.04クリーン環境でのビルド成功
- 既存のREADMEに記載された基本的な使用例の動作確認
- メモリリークやセグメンテーション違反の発生なし
- **libitm連携確認**: GCC TMランタイムとの正常な連携動作

## 6. 想定されるリスク

### 6.1 技術的リスク

- **Transactional Memoryの非互換性**: GCC TMインターフェースの根本的変更により大幅な修正が必要になる可能性
  - **Context7軽減要因**: TMサポートは継続されており、ABIは安定している
- **アセンブリコードの互換性**: 手書きアセンブリ（`.S`ファイル）がGCC 11で動作しない可能性
  - **対策**: x86 TME、PowerPC HTM命令セットは継続サポート確認済み
- **依存関係の複雑さ**: システムライブラリとの微妙な相互作用による予期しない問題
  - **glibc後方互換性**: compat symbolsによる実行時互換性は保たれる
- **実験的機能の変更**: GCC TMの実験的性質による将来的な変更リスク

### 6.2 対策

- 段階的アプローチ：まず基本的なコンパイルエラーを解決してから高度な問題に取り組む
- 既存コードの最小限の変更：可能な限り元の実装を保持
- テスト駆動：各修正段階でテストを実行して回帰を防ぐ
- **Context7知見活用**: GCC TMの具体的実装パターンを参考に修正方針を決定

## 7. 今後の検討事項

### 7.1 設計フェーズで詳細化すべき事項

- 具体的な関数宣言修正方法（マクロ使用 vs 直接修正）
- トランザクショナルメモリインターフェースの詳細な調査
- アセンブリコードの現代化方針（HTM/TME命令セット活用）
- ビルドシステムの改善方法（configure script導入等）
- **libitm統合**: 最適なTMアルゴリズム選択の自動化

### 7.2 実装優先度

1. **高優先度**: 基本的なコンパイルエラーの解決（関数宣言競合）
2. **中優先度**: 警告の解決とテスト実行（TM警告、インライン関数）
3. **低優先度**: 最適化とドキュメント改善（パフォーマンス、マニュアル更新）

### 7.3 Context7による技術的洞察

- **GCC TM継続性**: 実験的機能ながら削除予定はなく、安定したABI提供
- **アーキテクチャサポート**: x86_64での動作は継続保証、他アーキテクチャは要検証
- **互換性戦略**: glibc後方互換性メカニズムの活用による段階的移行