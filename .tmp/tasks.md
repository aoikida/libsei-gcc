# タスクリスト - libsei Ubuntu 22.04 移植プロジェクト

## 概要

- **総タスク数**: 23タスク
- **推定作業時間**: 3-4日
- **優先度**: 高
- **主要課題**: glibc 2.35互換性、GCC 11.4 TM警告、ビルドシステム適応

## タスク一覧

### Phase 1: 準備・分析 (6時間)

#### Task 1.1: 環境セットアップと現状分析

- [ ] 作業ブランチの作成とバックアップ
- [ ] 現在のビルドエラーの詳細記録
- [ ] GCC/glibc バージョン情報の確認と記録
- [ ] 依存関係（libitm等）の確認
- **完了条件**: 全エラーが分類・記録され、作業環境が準備完了
- **依存**: なし
- **推定時間**: 1時間

#### Task 1.2: glibc関数宣言差分の詳細分析

- [ ] `/usr/include/stdlib.h`でのstrtol系関数の実際の宣言確認
- [ ] `/usr/include/string.h`でのstring系関数の実際の宣言確認
- [ ] restrict修飾子の使用パターン分析
- [ ] libseiでの各関数の使用方法調査
- **完了条件**: 全関数の宣言差分が文書化され、修正方針が決定
- **依存**: Task 1.1
- **推定時間**: 2時間

#### Task 1.3: TM警告の根本原因分析

- [ ] `src/tmi.c`の静的変数アクセスパターン調査
- [ ] インライン関数とstatic変数の組み合わせ問題の理解
- [ ] GCC 11.4でのTM実装の変更点調査
- [ ] 修正アプローチの検討（static削除 vs マクロ化 vs extern化）
- **完了条件**: TM警告の原因が特定され、修正方針が決定
- **依存**: Task 1.1
- **推定時間**: 2時間

#### Task 1.4: テスト戦略の確認

- [ ] 既存テストスイートの動作確認
- [ ] `examples/simple`の現状確認
- [ ] `examples/ukv`の現状確認
- [ ] 回帰テスト手順の確立
- **完了条件**: 全テストが実行可能で、ベースライン結果が記録
- **依存**: なし
- **推定時間**: 1時間

### Phase 2: 中核互換性修正 (8時間)

#### Task 2.1: support.h関数宣言の修正

- [ ] `include/sei/support.h`でのstrtol系関数宣言をrestrict対応に修正
- [ ] SEI_DECLマクロの条件付きコンパイル対応検討
- [ ] glibc版判定マクロの追加（必要に応じて）
- [ ] 修正後のコンパイル確認
- **完了条件**: support.hの関数宣言がglibc 2.35と互換
- **依存**: Task 1.2
- **推定時間**: 2時間

#### Task 2.2: support.c関数実装の修正

- [ ] `src/support.c`での重複宣言問題の解決
- [ ] libc includeファイルとの順序調整
- [ ] 不要な宣言の削除または条件付き化
- [ ] カスタムlibc実装との整合性確認
- **完了条件**: support.cがエラーなくコンパイル
- **依存**: Task 2.1
- **推定時間**: 3時間

#### Task 2.3: TMI警告の修正

- [ ] `src/tmi.c`でのstatic inline関数問題の修正
- [ ] `__sei_thread`変数アクセスの修正
- [ ] `ignore_addr`関数の可視性修正
- [ ] ITM_*関数群の宣言調整
- [ ] TM警告の解消確認
- **完了条件**: tmi.c関連の全警告が解消
- **依存**: Task 1.3
- **推定時間**: 2時間

#### Task 2.4: ビルドシステムの調整

- [ ] Makefileでの新しいGCCフラグ対応確認
- [ ] 警告レベルの調整（必要に応じて）
- [ ] デバッグビルドでの動作確認
- [ ] 最適化ビルドでの動作確認
- **完了条件**: 全ビルド設定でエラーなくビルド完了
- **依存**: Task 2.1, 2.2, 2.3
- **推定時間**: 1時間

### Phase 3: 基本検証・テスト (6時間)

#### Task 3.1: ビルド成功の確認

- [ ] `make clean && make`での完全ビルド成功
- [ ] 警告数の大幅削減確認
- [ ] libsei.aライブラリの生成確認
- [ ] シンボルテーブルの正常性確認
- **完了条件**: クリーンビルドが警告最小で成功
- **依存**: Phase 2完了
- **推定時間**: 1時間

#### Task 3.2: 既存テストスイートの実行

- [ ] `make test`での全テスト実行
- [ ] 各テストの成功/失敗状況記録
- [ ] 失敗テストの原因分析
- [ ] 重要なテスト失敗の修正
- **完了条件**: 重要なテストが全て成功
- **依存**: Task 3.1
- **推定時間**: 2時間

#### Task 3.3: サンプルアプリケーションの検証

- [ ] `examples/simple`のビルドと実行
- [ ] 基本的なトランザクション動作確認
- [ ] CRC計算とメッセージ処理の確認
- [ ] メモリリーク検査（valgrind）
- **完了条件**: simpleサンプルが正常動作
- **依存**: Task 3.1
- **推定時間**: 2時間

#### Task 3.4: TM機能の基本検証

- [ ] 基本的なトランザクション開始・終了
- [ ] 冗長実行の動作確認
- [ ] エラー処理（CRC不一致等）の確認
- [ ] ITM関数群の動作確認
- **完了条件**: TM基本機能が正常動作
- **依存**: Task 3.3
- **推定時間**: 1時間

### Phase 4: 完全検証・仕上げ (4時間)

#### Task 4.1: 包括的テスト実行

- [ ] 全実行モード（cow, heap, instr）での動作確認
- [ ] 長時間安定性テスト
- [ ] 高負荷での動作確認
- [ ] エラー処理の包括的テスト
- **完了条件**: 全モードで安定動作
- **依存**: Phase 3完了
- **推定時間**: 2時間

#### Task 4.2: パフォーマンス検証

- [ ] 基本的なベンチマーク実行
- [ ] 元実装との性能比較（可能な範囲で）
- [ ] メモリ使用量の確認
- [ ] 性能劣化の有無確認
- **完了条件**: 性能要件（±10%）の達成確認
- **依存**: Task 4.1
- **推定時間**: 1時間

#### Task 4.3: ドキュメント更新

- [ ] CLAUDE.mdのビルド手順更新
- [ ] 互換性情報の記録
- [ ] トラブルシューティング情報の追加
- [ ] 変更履歴の記録
- **完了条件**: ドキュメントが最新状態に更新
- **依存**: Task 4.2
- **推定時間**: 1時間

## 実装順序

### 並行実行可能なタスク
- Task 1.2とTask 1.3（分析タスク）
- Task 3.2とTask 3.3（検証タスク）

### 順次実行必須
1. **Phase 1**: 1.1 → (1.2, 1.3) → 1.4
2. **Phase 2**: 2.1 → 2.2 → 2.3 → 2.4
3. **Phase 3**: 3.1 → (3.2, 3.3) → 3.4
4. **Phase 4**: 4.1 → 4.2 → 4.3

### クリティカルパス
Task 1.1 → Task 1.2 → Task 2.1 → Task 2.2 → Task 3.1 → Task 4.1

## リスクと対策

### 高リスク項目
- **関数宣言修正の影響範囲**: 段階的修正、小さなコミット単位
- **TM機能の根本的変更**: 既存動作との比較、フォールバック準備
- **性能劣化**: 各段階でのパフォーマンス測定

### 中リスク項目
- **テスト失敗**: 重要度による優先順位付け、段階的修正
- **アセンブリ互換性**: 現状では問題なし、要監視

### 対策
- 各Phaseでの段階的検証
- 失敗時のロールバック手順確立
- 重要な変更前のバックアップ作成

## 注意事項

### 開発方針
- **最小限の変更**: 既存ロジックへの影響最小化
- **段階的検証**: 各修正後の動作確認
- **後方互換性**: 既存APIの完全保持

### 品質管理
- 各タスクはコミット単位で完結
- 重要な変更は複数人でのレビュー
- テスト失敗時は原因調査を優先

### 制約事項
- **実験的機能依存**: GCC TMの制約受け入れ
- **アーキテクチャ限定**: x86_64でのテストに集中
- **研究用途**: 本番品質は要求されない

## 実装開始ガイド

### 開始前チェック
1. このタスクリストの理解
2. 作業環境の準備完了
3. バックアップの作成

### 実装フロー
1. **各タスクの開始時**: TodoWriteでin_progressに更新
2. **完了時**: TodoWriteでcompletedに更新
3. **問題発生時**: 速やかに状況報告と解決策検討

### 成功基準
- [ ] 全Phase完了
- [ ] 重要テスト全成功
- [ ] パフォーマンス要件達成
- [ ] ドキュメント更新完了

### 完了確認
最終的に以下が達成されていることを確認：
```bash
# ビルド成功
cd libsei && make clean && make

# テスト成功
make test

# サンプル動作
cd examples/simple && make && ./simple
```